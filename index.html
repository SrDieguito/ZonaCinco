<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reporte Diario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .input {
      @apply border border-gray-600 bg-gray-900 text-gold-400 p-2 rounded-xl w-full;
    }
    .label {
      @apply text-gold-400 font-medium;
    }
  </style>
</head>
<body class="bg-gray-900 text-gold-400 min-h-screen flex">
  <!-- Sidebar -->
  <div class="w-64 bg-gray-800 p-4 hidden md:block">
    <h2 class="text-xl font-bold mb-4">üìÅ Historial</h2>
    <label class="block mb-2">Filtrar por fecha:</label>
    <input type="date" id="filtro_fecha" class="input mb-4" />
    <ul id="lista_historial" class="space-y-2 text-sm"></ul>
  </div>

  <!-- Main -->
  <div class="flex-1 flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-2xl">
      <h1 class="text-2xl font-bold mb-6 text-center">üìä Reporte Diario</h1>
      <form id="reporteForm" class="grid grid-cols-1 gap-4">
        <div><label class="label">Fecha</label><input type="date" name="fecha" class="input" required /></div>
        <div><label class="label">Caja Inicial</label><input type="number" step="0.01" name="caja_inicial" class="input" required /></div>
        <div><label class="label">Ventas en Efectivo</label><input type="number" step="0.01" name="ventas_efectivo" class="input" required /></div>
        <div><label class="label">Transferencias</label><input type="number" step="0.01" name="ventas_transferencia" class="input" required /></div>
        <div><label class="label">Total Ventas</label><input type="number" name="total_ventas" readonly class="input bg-gray-700" /></div>

        <div class="mt-4"><label class="label">‚ûñ Egresos</label></div>
        <div class="flex items-center gap-2">
          <select id="categoria_egreso" class="input">
            <option value="Comida">Comida</option>
            <option value="Pago proveedor">Pago proveedor</option>
            <option value="Transportes">Transportes</option>
            <option value="Recreo">Recreo</option>
            <option value="Aseo">Aseo</option>
            <option value="Regalo prenda">Regalo prenda</option>
            <option value="Perdida prenda">P√©rdida prenda</option>
            <option value="Otro">Otro</option>
          </select>
          <input type="text" id="otro_egreso" class="input hidden" placeholder="Describir otro..." />
          <input type="number" step="0.01" id="monto_egreso" class="input w-32" placeholder="$" />
          <button type="button" id="agregar_egreso" class="bg-green-600 hover:bg-green-700 transition px-4 py-2 rounded-xl text-white">‚ûï</button>
        </div>
        <ul id="lista_egresos" class="list-disc pl-5 text-sm text-gold-300"></ul>
        <div><label class="label">Total Egresos</label><input type="number" name="total_egreso" readonly class="input bg-gray-700" /></div>

        <div><label class="label">¬øCu√°nto queda en caja?</label><input type="number" step="0.01" name="cuanto_queda" class="input" required /></div>
        <div><label class="label">Utilidad del D√≠a</label><input type="number" step="0.01" name="utilidad" class="input" required /></div>
        <div><label class="label">Total a Depositar</label><input type="number" step="0.01" name="total_depositar" readonly class="input bg-gray-700" /></div>

        <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 transition text-black py-2 rounded-xl font-bold">üíæ Guardar Reporte</button>
      </form>
      <div id="mensaje" class="mt-4 text-center text-sm"></div>
    </div>
  </div>

  <script>
    let egresos = [];

    function calcularTotalVentas() {
      const efectivo = parseFloat(document.querySelector('[name="ventas_efectivo"]').value) || 0;
      const transferencia = parseFloat(document.querySelector('[name="ventas_transferencia"]').value) || 0;
      document.querySelector('[name="total_ventas"]').value = (efectivo + transferencia).toFixed(2);
      calcularTotalDepositar();
    }

    function calcularTotalEgresos() {
      const total = egresos.reduce((acc, egreso) => acc + egreso.monto, 0);
      document.querySelector('[name="total_egreso"]').value = total.toFixed(2);
      return total;
    }

    function calcularTotalDepositar() {
      const cajaInicial = parseFloat(document.querySelector('[name="caja_inicial"]').value) || 0;
      const efectivo = parseFloat(document.querySelector('[name="ventas_efectivo"]').value) || 0;
      const transferencia = parseFloat(document.querySelector('[name="ventas_transferencia"]').value) || 0;
      const queda = parseFloat(document.querySelector('[name="cuanto_queda"]').value) || 0;
      const totalEgresos = calcularTotalEgresos();

      const total = cajaInicial + efectivo + transferencia - queda - totalEgresos;
      document.querySelector('[name="total_depositar"]').value = total.toFixed(2);
    }

    function renderEgresos() {
      const lista = document.getElementById('lista_egresos');
      lista.innerHTML = '';
      egresos.forEach((egreso, index) => {
        const li = document.createElement('li');
        li.textContent = `${egreso.categoria}: $${egreso.monto.toFixed(2)}`;
        const btn = document.createElement('button');
        btn.textContent = '‚ùå';
        btn.className = 'ml-2 text-red-400';
        btn.onclick = () => {
          egresos.splice(index, 1);
          renderEgresos();
          calcularTotalDepositar();
        };
        li.appendChild(btn);
        lista.appendChild(li);
      });
    }

    document.getElementById('categoria_egreso').addEventListener('change', (e) => {
      document.getElementById('otro_egreso').classList.toggle('hidden', e.target.value !== 'Otro');
    });

    document.getElementById('agregar_egreso').addEventListener('click', () => {
      const categoria = document.getElementById('categoria_egreso').value === 'Otro'
        ? document.getElementById('otro_egreso').value.trim()
        : document.getElementById('categoria_egreso').value;
      const monto = parseFloat(document.getElementById('monto_egreso').value);
      if (!categoria || isNaN(monto) || monto <= 0) return;
      egresos.push({ categoria, monto });
      renderEgresos();
      calcularTotalDepositar();
      document.getElementById('monto_egreso').value = '';
      document.getElementById('otro_egreso').value = '';
    });

    document.querySelector('[name="ventas_efectivo"]').addEventListener('input', calcularTotalVentas);
    document.querySelector('[name="ventas_transferencia"]').addEventListener('input', calcularTotalVentas);
    document.querySelector('[name="caja_inicial"]').addEventListener('input', calcularTotalDepositar);
    document.querySelector('[name="cuanto_queda"]').addEventListener('input', calcularTotalDepositar);

    document.getElementById('reporteForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const form = e.target;
      const data = {
        fecha: form.fecha.value,
        caja_inicial: parseFloat(form.caja_inicial.value),
        ventas_efectivo: parseFloat(form.ventas_efectivo.value),
        ventas_transferencia: parseFloat(form.ventas_transferencia.value),
        egresos: calcularTotalEgresos(),
        utilidad: parseFloat(form.utilidad.value),
        cuanto_queda: parseFloat(form.cuanto_queda.value),
        total_depositar: parseFloat(form.total_depositar.value),
        detalle_egresos: egresos,
      };

      try {
        const res = await fetch('/api/save-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await res.json();
        const mensaje = document.getElementById('mensaje');

        if (res.ok) {
          mensaje.textContent = '‚úÖ Reporte guardado con √©xito';
          mensaje.className = 'text-green-500';
          form.reset();
          egresos = [];
          renderEgresos();
          calcularTotalVentas();
          generarPDF(data);
        } else {
          mensaje.textContent = '‚ùå Error: ' + (result.errors ? result.errors.join(', ') : result.message);
          mensaje.className = 'text-red-500';
        }
      } catch (err) {
        console.error(err);
        document.getElementById('mensaje').textContent = '‚ùå Error de red o del servidor';
        document.getElementById('mensaje').className = 'text-red-500';
      }
    });

    function generarPDF(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Reporte Diario", 10, 10);
      let y = 20;
      for (let key in data) {
        if (key !== 'detalle_egresos') {
          doc.text(`${key}: ${data[key]}`, 10, y);
          y += 10;
        }
      }
      doc.text("Detalle Egresos:", 10, y);
      y += 10;
      data.detalle_egresos.forEach((egreso) => {
        doc.text(`- ${egreso.categoria}: $${egreso.monto.toFixed(2)}`, 10, y);
        y += 10;
      });
      doc.save(`Reporte_${data.fecha}.pdf`);
    }

    renderEgresos();
    calcularTotalVentas();
  </script>
</body>
</html>
